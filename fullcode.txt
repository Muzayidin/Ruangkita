// Next.js 13+ Furniture Store â€” App Router Skeleton
// Salin setiap blok ke file terpisah sesuai komentarnya.

// ======================= app/layout.tsx =======================
import "./globals.css";
import type { Metadata } from "next";
import { CartProvider } from "@/components/CartProvider";
import { Navbar } from "@/components/Navbar";
import { CartSidebar } from "@/components/CartSidebar";
import { Footer } from "@/components/Footer";

export const metadata: Metadata = {
  title: "FurniCasa - Toko Furniture",
  description: "Toko furniture minimalis untuk rumah dan bisnis Anda.",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="id">
      <body className="bg-gray-100 text-gray-800">
        <CartProvider>
          <Navbar />
          {children}
          <Footer />
          <CartSidebar />
        </CartProvider>
      </body>
    </html>
  );
}

// ======================= data/products.ts =======================
export type Product = {
  id: string;
  slug: string;
  name: string;
  price: number;
  category: string;
  description: string;
  image?: string;
  featured?: boolean;
};

export const products: Product[] = [
  {
    id: "kursi-santai-relax",
    slug: "kursi-santai-relax",
    name: "Kursi Santai Relax",
    price: 2580000,
    category: "Kursi",
    description: "Kursi santai dengan rangka kayu solid dan busa premium.",
    image: "",
    featured: true,
  },
  {
    id: "lemari-kayu-klasik",
    slug: "lemari-kayu-klasik",
    name: "Lemari Kayu Klasik",
    price: 1320000,
    category: "Lemari",
    description: "Lemari dua pintu dengan finishing natural, cocok untuk kamar tidur.",
    image: "",
    featured: true,
  },
  {
    id: "kabinet-skandinavia",
    slug: "kabinet-skandinavia",
    name: "Kabinet Skandinavia",
    price: 1450000,
    category: "Lemari",
    description: "Kabinet minimalis gaya Skandinavia untuk ruang tamu atau kantor.",
    image: "",
    featured: true,
  },
  {
    id: "kursi-cafe-minimalis",
    slug: "kursi-cafe-minimalis",
    name: "Kursi Cafe Minimalis",
    price: 740000,
    category: "Kursi",
    description: "Kursi kayu dengan dudukan nyaman, ideal untuk cafe dan resto.",
    image: "",
    featured: false,
  },
  {
    id: "meja-kayu-minimalis",
    slug: "meja-kayu-minimalis",
    name: "Meja Kayu Minimalis",
    price: 800000,
    category: "Meja",
    description: "Meja serbaguna dengan desain sederhana untuk berbagai kebutuhan.",
    image: "",
    featured: false,
  },
  {
    id: "sofa-mini-hijau",
    slug: "sofa-mini-hijau",
    name: "Sofa Mini Hijau",
    price: 1350000,
    category: "Sofa",
    description: "Sofa dua dudukan dengan warna hijau soft untuk ruang keluarga.",
    image: "",
    featured: true,
  },
];

export const featuredProducts = products.filter((p) => p.featured);

// ======================= components/CartProvider.tsx =======================
"use client";

import { createContext, useContext, useEffect, useState } from "react";
import type { Product } from "@/data/products";

export type CartItem = {
  product: Product;
  qty: number;
};

type CartContextType = {
  items: CartItem[];
  addToCart: (product: Product) => void;
  removeItem: (productId: string) => void;
  total: number;
  open: boolean;
  setOpen: (open: boolean) => void;
};

const CartContext = createContext<CartContextType | undefined>(undefined);
const STORAGE_KEY = "furnicasa-cart-v1";

export function CartProvider({ children }: { children: React.ReactNode }) {
  const [items, setItems] = useState<CartItem[]>([]);
  const [open, setOpen] = useState(false);

  // Load cart from localStorage
  useEffect(() => {
    if (typeof window === "undefined") return;
    try {
      const raw = window.localStorage.getItem(STORAGE_KEY);
      if (raw) {
        setItems(JSON.parse(raw));
      }
    } catch (error) {
      console.error("Gagal memuat keranjang", error);
    }
  }, []);

  // Save cart to localStorage
  useEffect(() => {
    if (typeof window === "undefined") return;
    try {
      window.localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    } catch (error) {
      console.error("Gagal menyimpan keranjang", error);
    }
  }, [items]);

  const addToCart = (product: Product) => {
    setItems((prev) => {
      const existing = prev.find((it) => it.product.id === product.id);
      if (existing) {
        return prev.map((it) =>
          it.product.id === product.id ? { ...it, qty: it.qty + 1 } : it
        );
      }
      return [...prev, { product, qty: 1 }];
    });
    setOpen(true);
  };

  const removeItem = (productId: string) => {
    setItems((prev) => prev.filter((it) => it.product.id !== productId));
  };

  const total = items.reduce(
    (acc, it) => acc + it.product.price * it.qty,
    0
  );

  return (
    <CartContext.Provider
      value={{ items, addToCart, removeItem, total, open, setOpen }}
    >
      {children}
    </CartContext.Provider>
  );
}

export function useCart() {
  const ctx = useContext(CartContext);
  if (!ctx) {
    throw new Error("useCart harus digunakan di dalam CartProvider");
  }
  return ctx;
}

// ======================= components/Navbar.tsx =======================
"use client";

import Link from "next/link";
import { useCart } from "./CartProvider";

export function Navbar() {
  const { items, setOpen } = useCart();
  const count = items.reduce((acc, it) => acc + it.qty, 0);

  return (
    <header className="bg-white shadow sticky top-0 z-50">
      <div className="max-w-6xl mx-auto flex items-center justify-between p-4">
        <Link href="/" className="text-xl font-bold text-slate-700">
          Furni<span className="text-orange-500">Casa</span>
        </Link>
        <nav className="hidden md:flex gap-4 text-sm text-gray-600">
          <Link href="/">Beranda</Link>
          <Link href="/products">Katalog</Link>
        </nav>
        <button
          onClick={() => setOpen(true)}
          className="relative bg-white border p-2 rounded-full shadow hover:bg-gray-50"
        >
          <span role="img" aria-label="cart">
            ðŸ›’
          </span>
          {count > 0 && (
            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs px-1 rounded-full">
              {count}
            </span>
          )}
        </button>
      </div>
    </header>
  );
}

// ======================= components/Footer.tsx =======================
export function Footer() {
  return (
    <footer className="mt-10 bg-slate-900 text-gray-300 py-6 text-sm">
      <div className="max-w-6xl mx-auto px-4 flex flex-col md:flex-row justify-between gap-4">
        <div>
          <p className="font-semibold text-white">FurniCasa</p>
          <p className="text-gray-400 max-w-md">
            Toko furniture online yang menyediakan berbagai kebutuhan interior rumah
            dan bisnis Anda. Kami mengutamakan kualitas, kenyamanan, dan desain yang timeless.
          </p>
        </div>
        <div className="text-gray-400">
          <p>Â© {new Date().getFullYear()} FurniCasa. All rights reserved.</p>
        </div>
      </div>
    </footer>
  );
}

// ======================= components/CartSidebar.tsx =======================
"use client";

import { useCart } from "./CartProvider";

export function CartSidebar() {
  const { items, removeItem, total, open, setOpen } = useCart();

  const waNumber = "6281234567890"; // ganti dengan nomor WhatsApp kamu

  const messageLines = items.map((item, index) =>
    `${index + 1}. ${item.product.name} x${item.qty} - Rp ${(
      item.product.price * item.qty
    ).toLocaleString("id-ID")}`
  );

  const waMessage =
    `Halo, saya ingin memesan furniture berikut:

` +
    (messageLines.length ? messageLines.join("\n") : "(belum ada item)") +
    `

Total: Rp ${total.toLocaleString("id-ID")}

Nama:
Alamat lengkap:
Catatan tambahan:`;

  const waLink = `https://wa.me/${waNumber}?text=${encodeURIComponent(
    waMessage
  )}`;

  return (
    <aside
      className={`fixed top-0 right-0 h-full w-80 bg-white shadow-2xl p-4 flex flex-col transform transition-transform duration-300 z-[999] ${
        open ? "translate-x-0" : "translate-x-full"
      }`}
    >
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-lg font-semibold">Keranjang Belanja</h3>
        <button onClick={() => setOpen(false)} className="text-2xl">
          Ã—
        </button>
      </div>
      <div className="flex-1 overflow-y-auto space-y-2">
        {items.length === 0 && (
          <p className="text-gray-500 text-sm">
            Keranjang masih kosong. Tambahkan produk dari katalog.
          </p>
        )}
        {items.map((item) => (
          <div
            key={item.product.id}
            className="border-b pb-2 flex justify-between items-start gap-2"
          >
            <div>
              <p className="text-sm font-medium">{item.product.name}</p>
              <p className="text-xs text-gray-500">
                x{item.qty} Â· Rp{" "}
                {(item.product.price * item.qty).toLocaleString("id-ID")}
              </p>
            </div>
            <button
              className="text-xs text-red-500"
              onClick={() => removeItem(item.product.id)}
            >
              Hapus
            </button>
          </div>
        ))}
      </div>
      <div className="border-t pt-3 mt-3 space-y-2">
        <div className="flex justify-between text-sm font-semibold">
          <span>Total</span>
          <span>Rp {total.toLocaleString("id-ID")}</span>
        </div>
        <a
          href={waLink}
          target="_blank"
          className={`block text-center text-sm py-2 rounded ${
            items.length === 0
              ? "bg-gray-300 cursor-not-allowed"
              : "bg-green-600 hover:bg-green-700 text-white"
          }`}
          aria-disabled={items.length === 0}
        >
          Checkout via WhatsApp
        </a>
      </div>
    </aside>
  );
}

// ======================= components/ProductCard.tsx =======================
"use client";

import Link from "next/link";
import type { Product } from "@/data/products";
import { useCart } from "./CartProvider";

export function ProductCard({ product }: { product: Product }) {
  const { addToCart } = useCart();

  return (
    <div className="bg-white rounded-xl shadow p-4 flex flex-col">
      <div className="bg-gray-200 h-32 mb-3 flex items-center justify-center text-gray-500 text-sm rounded-lg overflow-hidden">
        {product.image ? (
          // eslint-disable-next-line @next/next/no-img-element
          <img
            src={product.image}
            alt={product.name}
            className="h-full w-full object-cover"
          />
        ) : (
          "(Foto produk)"
        )}
      </div>
      <Link
        href={`/products/${product.slug}`}
        className="font-semibold text-sm mb-1 hover:text-orange-600"
      >
        {product.name}
      </Link>
      <p className="text-orange-600 font-bold text-sm mb-2">
        Rp {product.price.toLocaleString("id-ID")}
      </p>
      <p className="text-xs text-gray-500 mb-3 line-clamp-2">
        {product.description}
      </p>
      <div className="mt-auto flex gap-2">
        <button
          onClick={() => addToCart(product)}
          className="flex-1 bg-slate-900 text-white px-3 py-2 rounded text-xs"
        >
          Tambah ke Keranjang
        </button>
        <Link
          href={`/products/${product.slug}`}
          className="text-xs border px-3 py-2 rounded bg-white"
        >
          Detail
        </Link>
      </div>
    </div>
  );
}

// ======================= app/page.tsx (Home) =======================
import Link from "next/link";
import { featuredProducts } from "@/data/products";
import { ProductCard } from "@/components/ProductCard";

export default function Home() {
  return (
    <main className="max-w-6xl mx-auto px-4 py-6 space-y-10">
      {/* Hero Section */}
      <section className="grid md:grid-cols-2 gap-6 items-center">
        <div>
          <p className="inline-flex items-center gap-2 text-xs bg-slate-100 rounded-full px-3 py-1 mb-3">
            <span className="w-4 h-4 rounded-full bg-green-500 inline-block" />
            <span>Garansi kualitas & pengiriman aman</span>
          </p>
          <h1 className="text-3xl md:text-4xl font-bold text-slate-800 mb-3">
            Furniture Minimalis untuk {""}
            <span className="text-orange-500">Rumah Impian</span> Anda
          </h1>
          <p className="text-gray-600 text-sm mb-4 max-w-lg">
            Pilihan kursi, meja, sofa, dan lemari dengan desain modern, cocok untuk
            rumah, kantor, maupun coffee shop Anda.
          </p>
          <div className="flex flex-wrap gap-3 items-center">
            <Link
              href="/products"
              className="bg-slate-900 text-white px-4 py-2 rounded-full text-sm shadow"
            >
              Lihat Katalog
            </Link>
            <a
              href="https://wa.me/6281234567890"
              target="_blank"
              className="border border-slate-300 px-4 py-2 rounded-full text-sm"
            >
              Chat via WhatsApp
            </a>
          </div>
        </div>
        <div className="bg-white rounded-2xl shadow h-60 flex items-center justify-center">
          <span className="text-gray-400 text-sm">(Gambar ruang tamu minimalis)</span>
        </div>
      </section>

      {/* Produk Unggulan */}
      <section>
        <div className="flex items-end justify-between mb-4">
          <div>
            <h2 className="text-xl font-semibold">Produk Unggulan</h2>
            <p className="text-xs text-gray-500">
              Produk yang paling banyak diminati pelanggan.
            </p>
          </div>
          <Link href="/products" className="text-xs text-slate-700">
            Lihat semua produk â†’
          </Link>
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          {featuredProducts.map((product) => (
            <ProductCard key={product.id} product={product} />
          ))}
        </div>
      </section>
    </main>
  );
}

// ======================= app/products/page.tsx (Katalog) =======================
import { products } from "@/data/products";
import { ProductCard } from "@/components/ProductCard";

export default function ProductsPage() {
  return (
    <main className="max-w-6xl mx-auto px-4 py-6 space-y-6">
      <header className="flex items-end justify-between mb-2">
        <div>
          <h1 className="text-2xl font-semibold">Katalog Produk</h1>
          <p className="text-xs text-gray-500">
            Pilih furniture sesuai kebutuhan ruang Anda.
          </p>
        </div>
      </header>
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {products.map((product) => (
          <ProductCard key={product.id} product={product} />
        ))}
      </div>
    </main>
  );
}

// ======================= app/products/[slug]/page.tsx (Detail Produk) =======================
import { notFound } from "next/navigation";
import { products } from "@/data/products";
import { ProductCard } from "@/components/ProductCard";

interface ProductDetailProps {
  params: { slug: string };
}

export default function ProductDetailPage({ params }: ProductDetailProps) {
  const product = products.find((p) => p.slug === params.slug);

  if (!product) {
    notFound();
  }

  const related = products.filter(
    (p) => p.category === product.category && p.id !== product.id
  );

  return (
    <main className="max-w-6xl mx-auto px-4 py-6 space-y-8">
      <section className="grid md:grid-cols-2 gap-6">
        <div className="bg-white rounded-2xl shadow h-64 flex items-center justify-center overflow-hidden">
          {product.image ? (
            // eslint-disable-next-line @next/next/no-img-element
            <img
              src={product.image}
              alt={product.name}
              className="h-full w-full object-cover"
            />
          ) : (
            <span className="text-gray-400 text-sm">(Foto produk)</span>
          )}
        </div>
        <div className="space-y-3">
          <p className="text-xs uppercase tracking-wide text-gray-500">
            {product.category}
          </p>
          <h1 className="text-2xl font-semibold text-slate-800">
            {product.name}
          </h1>
          <p className="text-orange-600 font-bold text-xl">
            Rp {product.price.toLocaleString("id-ID")}
          </p>
          <p className="text-sm text-gray-600">{product.description}</p>
          <p className="text-xs text-gray-400">
            *Harga belum termasuk ongkos kirim dan aksesoris tambahan.
          </p>
        </div>
      </section>

      {related.length > 0 && (
        <section className="space-y-3">
          <h2 className="text-lg font-semibold">Produk Terkait</h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {related.map((p) => (
              <ProductCard key={p.id} product={p} />
            ))}
          </div>
        </section>
      )}
    </main>
  );
}

// ======================= app/admin/login/page.tsx =======================
"use client";
import { useState } from "react";
import { useRouter } from "next/navigation";

export default function AdminLoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");

  async function handleLogin(e) {
    e.preventDefault();
    setError("");

    const res = await fetch("/api/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });

    const data = await res.json();
    if (!res.ok) {
      setError(data.error || "Login gagal");
      return;
    }

    router.push("/admin/products");
  }

  return (
    <main className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
      <form
        onSubmit={handleLogin}
        className="bg-white shadow p-6 w-full max-w-sm rounded space-y-4"
      >
        <h1 className="text-xl font-semibold text-center">Login Admin</h1>

        {error && (
          <p className="text-sm text-red-600 bg-red-100 p-2 rounded">{error}</p>
        )}

        <div>
          <label className="text-sm">Email</label>
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="w-full border px-3 py-2 rounded mt-1"
            required
          />
        </div>

        <div>
          <label className="text-sm">Password</label>
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="w-full border px-3 py-2 rounded mt-1"
            required
          />
        </div>

        <button className="w-full bg-slate-900 text-white py-2 rounded">
          Login
        </button>
      </form>
    </main>
  );
}

// ======================= app/api/auth/login/route.ts =======================
import { NextResponse } from "next/server";
import bcrypt from "bcryptjs";
import { cookies } from "next/headers";

const ADMIN_EMAIL = "admin@ruangkita.com";
const ADMIN_PASSWORD_HASH =
  "$2a$10$1KNIJOUxRKAtwHiHSEjHXuKNE8ZS4LnN5FjJAGxabQzpgrOZU6Wfe"; // hash dari admin123

export async function POST(req: Request) {
  try {
    const { email, password } = await req.json();

    if (email !== ADMIN_EMAIL) {
      return NextResponse.json({ error: "Email tidak ditemukan" }, { status: 401 });
    }

    const valid = await bcrypt.compare(password, ADMIN_PASSWORD_HASH);
    if (!valid) {
      return NextResponse.json({ error: "Password salah" }, { status: 401 });
    }

    cookies().set("admin_session", "logged_in", {
      httpOnly: true,
      path: "/",
      maxAge: 60 * 60 * 24,
    });

    return NextResponse.json({ success: true });
  } catch {
    return NextResponse.json({ error: "Bad request" }, { status: 400 });
  }
}

// ======================= app/api/auth/logout/route.ts =======================
import { cookies } from "next/headers";
import { NextResponse } from "next/server";

export async function POST() {
  cookies().set("admin_session", "", { maxAge: 0, path: "/" });
  return NextResponse.json({ success: true });
}

// ======================= middleware.ts =======================
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

export function middleware(req: NextRequest) {
  const session = req.cookies.get("admin_session")?.value;
  const path = req.nextUrl.pathname;

  const isAdminPage = path.startsWith("/admin");
  const isLoginPage = path === "/admin/login";

  if (isLoginPage && session) {
    return NextResponse.redirect(new URL("/admin/products", req.url));
  }

  if (isAdminPage && !isLoginPage && !session) {
    return NextResponse.redirect(new URL("/admin/login", req.url));
  }

  return NextResponse.next();
}

export const config = {
  matcher: ["/admin/:path*"],
};
